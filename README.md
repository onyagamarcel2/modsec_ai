# üõ°Ô∏è ModSec AI - D√©tection d'Anomalies en Temps R√©el pour ModSecurity

[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue)](https://www.python.org/downloads/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)
[![Documentation](https://img.shields.io/badge/docs-latest-brightgreen)](docs/)
[![Tests](https://img.shields.io/badge/tests-passing-brightgreen)](tests/)

ModSec AI est une solution avanc√©e de d√©tection d'anomalies en temps r√©el pour les logs ModSecurity, combinant l'intelligence artificielle et l'analyse comportementale pour renforcer la s√©curit√© de vos applications web.

## üéØ Introduction


### Contexte
Les logs ModSecurity g√©n√®rent un volume important de donn√©es de s√©curit√© qui n√©cessitent une analyse continue. Les approches traditionnelles bas√©es sur des r√®gles statiques ne suffisent plus face √† l'√©volution constante des menaces.

### Objectifs
- D√©tection en temps r√©el des comportements anormaux dans les logs ModSecurity
- Apprentissage continu pour s'adapter aux nouveaux patterns l√©gitimes
- R√©duction des faux positifs gr√¢ce √† l'analyse comportementale
- Am√©lioration continue de la d√©tection via le r√©entra√Ænement du mod√®le

### Importance
ModSec AI s'inscrit dans une approche moderne de la s√©curit√© (DevSecOps) en :
- Automatisant l'analyse des logs de s√©curit√©
- Fournissant des insights en temps r√©el
- Permettant une r√©ponse proactive aux menaces
- S'int√©grant dans les pipelines CI/CD

## üß† Fonctionnalit√©s Principales

### üîç D√©tection en Temps R√©el
- Analyse continue des logs ModSecurity
- D√©tection imm√©diate des comportements anormaux
- Alertes configurables (email, Slack, webhook)

### üìä Analyse Comportementale
- Apprentissage des patterns l√©gitimes
- D√©tection des d√©viations comportementales
- R√©duction des faux positifs

### üîÑ Apprentissage Continu
- Mise √† jour automatique du mod√®le
- Adaptation aux nouveaux patterns
- Am√©lioration continue de la d√©tection

### üìà Visualisation & Reporting
- Dashboard interactif (Streamlit)
- Rapports d√©taill√©s des anomalies
- M√©triques de performance

## üèóÔ∏è Architecture Technique

```mermaid
flowchart TD
    subgraph "Data Sources"
        A[modsec_audit.log / .gz]
    end

    subgraph "1. Preprocessing"
        A --> B1[Log Parser<br/>Multi-section]
        B1 --> B2[Cleaning / Normalization]
    end

    subgraph "2. Feature Engineering"
        B2 --> C1[Vectorization<br/>TF-IDF + Word2Vec]
        C1 --> C2[Feature Extraction<br/>Statistical + Contextual]
    end

    subgraph "3. Model Management"
        C2 --> D1[Model Training & Evaluation<br/>Isolation Forest]
        D1 --> D2[Model Export .pkl]
        D2 --> D5[Anomaly Detection Engine Load Model]

        H2[Training Buffer] --> D3[Incremental Update<br/>Sliding Window]
        D3 --> D4[Model Retraining]
        D4 --> D2
    end

    subgraph "4. Real-Time Detection"
        F1[Watchdog Monitor<br/>modsec_audit.log]
        F1 --> F2[New Log Line Detected]
        F2 --> B1
        C2 --> D5[Anomaly Detection Engine Load Model]
        D5 --> F4[Is Anomaly?]

        F4 -->|Yes| G1[Alerting System<br/>Log + Email + Webhook]
        F4 -->|Yes| G4[Anomalies Buffer<br/>En attente de validation]
        F4 -->|No| G2[Update Knowledge Base]

        G4 --> G5[Validation humaine ou AI-Assisted]
        G5 -->|Valid√© comme normal| H2[Training Buffer]
    end

    subgraph "5. Visualization & Logs"
        G1 --> H1[JSON/CSV Logs]
        G2 --> H2[Training Buffer]
        H1 --> I1[Streamlit Dashboard<br/>or Grafana + InfluxDB]
        H2 --> D3
    end

    subgraph "6. ModSecurity Improvement"
        J1[Validation de la vuln√©rabilit√©] --> J2[Formulation de nouvelles r√®gles]
        J2 --> J3[Configuration ModSecurity<br/>mise √† jour des r√®gles de s√©curit√©]
        J3 --> I1
    end

    %% Nouveau flux de validation
    F4 -->|Yes| J1

    %% Styles communs
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B1 fill:#ffe,stroke:#333
    style B2 fill:#ffe,stroke:#333
    style C1 fill:#ddf,stroke:#333
    style C2 fill:#ddf,stroke:#333
    style D1 fill:#bfb,stroke:#333
    style D2 fill:#bfb,stroke:#333
    style D3 fill:#bfb,stroke:#333
    style D4 fill:#bfb,stroke:#333
    style D5 fill:#bfb,stroke:#333
    style F4 fill:#bff,stroke:#333
    style G1 fill:#fcc,stroke:#333
    style G2 fill:#fcc,stroke:#333
    style G4 fill:#fc9,stroke:#333
    style G5 fill:#fc9,stroke:#333
    style H1 fill:#bbf,stroke:#333
    style H2 fill:#ccf,stroke:#333
    style I1 fill:#bbf,stroke:#333
    style J1 fill:#cfc,stroke:#333
    style J2 fill:#cfc,stroke:#333
    style J3 fill:#cfc,stroke:#333
```

### Flux de S√©quence Complet

```mermaid
sequenceDiagram
    participant WM as Watchdog Monitor
    participant LP as Log Parser
    participant CN as Cleaning/Normalization
    participant VE as Vectorization
    participant FE as Feature Extraction
    participant AD as Anomaly Detection
    participant AS as Alerting System
    participant AB as Anomalies Buffer
    participant KB as Knowledge Base
    participant TB as Training Buffer
    participant MU as Model Update
    participant VR as Validation Rules
    participant DB as Dashboard

    %% Phase d'initialisation
    Note over AD,MU: Phase d'Initialisation
    AD->>MU: Charger mod√®le initial
    MU-->>AD: Mod√®le charg√©

    %% Boucle de d√©tection
    loop Surveillance Continue
        WM->>LP: Nouveau log d√©tect√©
        LP->>CN: Log pars√©
        CN->>VE: Donn√©es nettoy√©es
        VE->>FE: Vecteurs g√©n√©r√©s
        FE->>AD: Features extraites
        AD->>AD: √âvaluation anomalie

        alt Anomalie d√©tect√©e
            AD->>AS: Alerte g√©n√©r√©e
            AD->>AB: Stockage anomalie
            AD->>VR: Validation requise
            VR->>DB: Affichage pour validation
            
            alt Validation humaine
                DB->>VR: Confirmation utilisateur
                VR->>KB: Mise √† jour base de connaissances
            else Validation automatique
                VR->>KB: Mise √† jour automatique
            end
        else Comportement normal
            AD->>KB: Mise √† jour base de connaissances
            KB->>TB: Ajout au buffer d'entra√Ænement
        end

        %% Mise √† jour du mod√®le
        alt Buffer plein ou p√©riode √©coul√©e
            TB->>MU: D√©clenchement mise √† jour
            MU->>MU: R√©entra√Ænement mod√®le
            MU->>AD: Mise √† jour mod√®le
        end
    end
```

### Description des Composants

#### 1. Preprocessing
- **Log Parser** : Analyse multi-section des logs ModSecurity
- **Cleaning/Normalization** : Nettoyage et standardisation des donn√©es

#### 2. Feature Engineering
- **Vectorization** : Transformation en vecteurs (TF-IDF + Word2Vec)
- **Feature Extraction** : Extraction de caract√©ristiques statistiques et contextuelles

#### 3. Model Management
- **Model Training** : Entra√Ænement et √©valuation du mod√®le Isolation Forest
- **Model Export** : Sauvegarde du mod√®le entra√Æn√©
- **Incremental Update** : Mise √† jour incr√©mentale avec fen√™tre glissante
- **Model Retraining** : R√©entra√Ænement p√©riodique du mod√®le

#### 4. Real-Time Detection
- **Watchdog Monitor** : Surveillance en temps r√©el des logs
- **Anomaly Detection** : D√©tection des anomalies
- **Alerting System** : Syst√®me d'alertes multi-canal
- **Validation** : Processus de validation humaine ou assist√©e par IA

#### 5. Visualization & Logs
- **JSON/CSV Logs** : Stockage structur√© des logs
- **Training Buffer** : Buffer d'apprentissage
- **Dashboard** : Interface de visualisation (Streamlit/Grafana)

#### 6. ModSecurity Improvement
- **Validation** : Validation des vuln√©rabilit√©s d√©tect√©es
- **Rule Formulation** : Cr√©ation de nouvelles r√®gles
- **Configuration** : Mise √† jour des r√®gles ModSecurity

## üèóÔ∏è Architecture Technique Compl√®te

```mermaid
graph TD
    subgraph "Ingestion & Pr√©traitement"
        A1[ModSecLogLoader] --> |Logs bruts| B1[ModSecPreprocessor]
        B1 --> |Logs nettoy√©s| C1[ModSecParser]
        C1 --> |Logs structur√©s| D1[FeatureExtractor]
    end

    subgraph "Vectorisation & D√©tection"
        D1 --> |Features| E1[LogVectorizer]
        E1 --> |Vecteurs| F1[AnomalyDetector]
        F1 --> |Scores| G1[ModelUpdater]
        G1 --> |Mise √† jour| E1
    end

    subgraph "Interface & Monitoring"
        F1 --> |Alertes| H1[NotificationManager]
        F1 --> |M√©triques| I1[PerformanceMonitor]
        F1 --> |Donn√©es| J1[Dashboard]
        F1 --> |API| K1[FastAPI]
    end

    subgraph "Stockage & Cache"
        L1[VectorCache] --> |Cache| E1
        M1[AlertManager] --> |Historique| H1
        N1[GUIDataManager] --> |√âtat| J1
    end

    subgraph "Utilitaires"
        O1[RuleBasedDetector] --> |R√®gles| F1
        P1[RealTimeDetector] --> |Streaming| F1
    end

    subgraph "Cycle d'Am√©lioration"
        J1 --> |Confirmation| Q1[FeedbackManager]
        K1 --> |Validation| Q1
        Q1 --> |Feedback| G1
        Q1 --> |Nouvelles r√®gles| R1[RuleGenerator]
        R1 --> |R√®gles ModSecurity| S1[ModSecRuleManager]
        S1 --> |Mise √† jour| O1
    end

    subgraph "Entra√Ænement & R√©entra√Ænement"
        T1[TrainingPipeline] --> |Donn√©es d'entra√Ænement| U1[ModelTrainer]
        U1 --> |Mod√®le initial| F1
        V1[RetrainingScheduler] --> |D√©clencheur| W1[IncrementalTrainer]
        W1 --> |Mise √† jour| G1
    end

    style A1 fill:#f9f,stroke:#333,stroke-width:2px
    style F1 fill:#bbf,stroke:#333,stroke-width:2px
    style J1 fill:#bfb,stroke:#333,stroke-width:2px
    style K1 fill:#bfb,stroke:#333,stroke-width:2px
    style Q1 fill:#fbb,stroke:#333,stroke-width:2px
    style U1 fill:#fbb,stroke:#333,stroke-width:2px
```

### Composants D√©taill√©s

#### Ingestion & Pr√©traitement
- **ModSecLogLoader** : Chargement et validation des logs ModSecurity
- **ModSecPreprocessor** : Nettoyage et normalisation des donn√©es
- **ModSecParser** : Extraction structur√©e des informations
- **FeatureExtractor** : Extraction des caract√©ristiques pertinentes

#### Vectorisation & D√©tection
- **LogVectorizer** : Transformation en vecteurs (Word2Vec/TF-IDF)
- **AnomalyDetector** : D√©tection des anomalies (Isolation Forest, LOF, etc.)
- **ModelUpdater** : Mise √† jour incr√©mentale du mod√®le

#### Interface & Monitoring
- **NotificationManager** : Gestion des alertes (email, Slack, webhook)
- **PerformanceMonitor** : Suivi des m√©triques de performance
- **Dashboard** : Interface utilisateur Streamlit
- **FastAPI** : API REST pour l'int√©gration

#### Stockage & Cache
- **VectorCache** : Cache des vecteurs pour optimisation
- **AlertManager** : Gestion de l'historique des alertes
- **GUIDataManager** : Gestion de l'√©tat de l'interface

#### Utilitaires
- **RuleBasedDetector** : D√©tection bas√©e sur des r√®gles
- **RealTimeDetector** : D√©tection en temps r√©el

#### Cycle d'Am√©lioration
- **FeedbackManager** : Gestion des retours utilisateur
- **RuleGenerator** : G√©n√©ration de nouvelles r√®gles
- **ModSecRuleManager** : Gestion des r√®gles ModSecurity

#### Entra√Ænement & R√©entra√Ænement
- **TrainingPipeline** : Pipeline d'entra√Ænement initial
- **ModelTrainer** : Entra√Ænement du mod√®le
- **RetrainingScheduler** : Planification du r√©entra√Ænement
- **IncrementalTrainer** : Entra√Ænement incr√©mental

## üìä Flux de Donn√©es global

```mermaid
sequenceDiagram
    participant DL as DataLoader
    participant PP as Preprocessor
    participant P as Parser
    participant FE as FeatureExtractor
    participant AD as AnomalyDetector
    participant MU as ModelUpdater
    
    DL->>PP: Raw Logs
    PP->>P: Cleaned Data
    P->>FE: Parsed Entries
    FE->>AD: Feature Vectors
    AD->>MU: Anomaly Results
    MU->>FE: Updated Model
```

## üìÅ Structure du Projet

```
modsec_ai/
‚îú‚îÄ‚îÄ config/             # Configuration files
‚îú‚îÄ‚îÄ docs/              # Documentation
‚îú‚îÄ‚îÄ scripts/           # Utility scripts
‚îú‚îÄ‚îÄ src/               # Source code
‚îÇ   ‚îú‚îÄ‚îÄ api/          # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ core/         # Core functionality
‚îÇ   ‚îú‚îÄ‚îÄ models/       # ML models
‚îÇ   ‚îî‚îÄ‚îÄ utils/        # Utilities
‚îú‚îÄ‚îÄ tests/            # Test suite
‚îú‚îÄ‚îÄ .pylintrc         # Pylint configuration
‚îú‚îÄ‚îÄ mypy.ini          # Mypy configuration
‚îú‚îÄ‚îÄ requirements.txt  # Dependencies
‚îî‚îÄ‚îÄ setup.py         # Package setup
```

## üß© Modules & Composants

### üì¶ DataLoader
- R√¥le : Chargement et validation des logs ModSecurity
- Documentation : [docs/dataloader.md](docs/dataloader.md)

### üîß Preprocessor
- R√¥le : Nettoyage et normalisation des donn√©es
- Documentation : [docs/preprocessor.md](docs/preprocessor.md)

### üìù Parser
- R√¥le : Extraction structur√©e des informations des logs
- Documentation : [docs/parser.md](docs/parser.md)

### üéØ FeatureExtractor
- R√¥le : Transformation des donn√©es en vecteurs exploitables
- Documentation : [docs/feature_extractor.md](docs/feature_extractor.md)

### üß† AnomalyDetector
- R√¥le : D√©tection des comportements anormaux
- Documentation : [docs/anomaly_detector.md](docs/anomaly_detector.md)

### üîÑ ModelUpdater
- R√¥le : Mise √† jour continue du mod√®le
- Documentation : [docs/model_updater.md](docs/model_updater.md)

### üëÄ WatchdogMonitor
- R√¥le : Surveillance continue des fichiers de logs ModSecurity
- Documentation : [docs/watchdog_monitor.md](docs/watchdog_monitor.md)

### üßπ CleaningNormalization
- R√¥le : Nettoyage et standardisation des donn√©es
- Documentation : [docs/cleaning_normalization.md](docs/cleaning_normalization.md)

### üìä Vectorization
- R√¥le : Transformation des logs en vecteurs
- Documentation : [docs/vectorization.md](docs/vectorization.md)

### üîî AlertingSystem
- R√¥le : Gestion des alertes et notifications
- Documentation : [docs/alerting_system.md](docs/alerting_system.md)

### üì• AnomaliesBuffer
- R√¥le : Stockage temporaire des anomalies
- Documentation : [docs/anomalies_buffer.md](docs/anomalies_buffer.md)

### üß† KnowledgeBase
- R√¥le : Base de connaissances des patterns
- Documentation : [docs/knowledge_base.md](docs/knowledge_base.md)

### üìö TrainingBuffer
- R√¥le : Buffer d'entra√Ænement du mod√®le
- Documentation : [docs/training_buffer.md](docs/training_buffer.md)

### ‚úÖ ValidationRules
- R√¥le : Gestion des r√®gles de validation
- Documentation : [docs/validation_rules.md](docs/validation_rules.md)

### üìä Dashboard
- R√¥le : Interface utilisateur pour la visualisation et la validation
- Documentation : [docs/dashboard.md](docs/dashboard.md)

## ‚öôÔ∏è Installation

### Pr√©requis
- Python 3.8+
- pip
- virtualenv (recommand√©)

### Installation

1. Cloner le repository :
```bash
git clone https://github.com/yourusername/modsec_ai.git
cd modsec_ai
```

2. Cr√©er et activer l'environnement virtuel :
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
.\venv\Scripts\activate   # Windows
```

3. Installer les d√©pendances :
```bash
pip install -r requirements.txt
```

4. Configuration :
```bash
cp config/config.example.yaml config/config.yaml
# √âditer config.yaml avec vos param√®tres
```

## üöÄ Guide de D√©marrage Rapide

1. Lancer le pipeline de d√©tection :
```bash
python -m modsec_ai.src.core.pipeline
```

2. D√©marrer le dashboard :
```bash
streamlit run modsec_ai/src/api/dashboard.py
```

3. Acc√©der √† l'API :
```bash
uvicorn modsec_ai.src.api.main:app --reload
```

## üìö Documentation

La documentation compl√®te est disponible dans le dossier `docs/` :
- [Guide d'installation](docs/installation.md)
- [Guide d'utilisation](docs/usage.md)
- [Architecture](docs/architecture.md)
- [API Reference](docs/api.md)
- [Configuration](docs/configuration.md)

## üôã Contribuer

1. Fork le projet
2. Cr√©er une branche (`git checkout -b feature/AmazingFeature`)
3. Commit les changements (`git commit -m 'Add AmazingFeature'`)
4. Push vers la branche (`git push origin feature/AmazingFeature`)
5. Ouvrir une Pull Request

### Contact
- Email : onyagamarcel2@gmail.com
- Issues : [GitHub Issues](https://github.com/onyagamarcel2/modsec_ai/issues)

## ‚öñÔ∏è Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

## üè∑Ô∏è Cr√©dits


- [Drain3](https://github.com/IBM/Drain3) - Base du parser de logs
- [Scikit-learn](https://scikit-learn.org/) - Algorithmes de d√©tection d'anomalies


---

<div align="center">
  <sub>Built with ‚ù§Ô∏è by Marcel ONYAGA</sub>
</div> 